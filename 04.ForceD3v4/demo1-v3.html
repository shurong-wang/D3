<!DOCTYPE html>
<html>

<head>
    <meta charset='utf-8' />
    <script type='text/javascript' src='js/plugins/d3/d3.v3.min.js'></script>
    <script type='text/javascript' src='js/plugins/jquery/jquery-1.9.1.js'></script>
    <link rel='stylesheet' href='css/demo.css' />
</head>

<body>

    <script type='text/javascript'>
        d3.json('./js/data/relation.json', function (data) {
            new initialize('body', {
                data
            });
        });

        function initialize(wrapper, config) {
            const forcrConfig = {
                data: { 'nodes': [], 'links': [] },
                width: window.innerWidth,
                height: window.innerHeight - 17,
                distance: 100
            };

            $.extend(true, forcrConfig, config);

            const { nodes, links } = forcrConfig.data;

            links.forEach(function (link) {
                if (typeof link.source != 'number' && typeof link.target != 'number') {
                    const sourceNode = nodes.filter(function (node) {
                        return node.name === link.source;
                    })[0];
                    const targetNode = nodes.filter(function (node) {
                        return node.name === link.target;
                    })[0];
                    link.source = sourceNode;
                    link.target = targetNode;
                }
            });

            const _this = this;
            let highlightNode = null;
            this.color = d3.scale.category20();

            const zoom = d3.behavior.zoom()
                .scaleExtent([0.2, 5])
                .on('zoom', function () {
                    _this.zoomed();
                });

            this.vis = d3.select('body').append('svg:svg')
                .attr('width', forcrConfig.width)
                .attr('height', forcrConfig.height)
                .call(zoom).on('dblclick.zoom', null);

            this.vis = this.vis.append('g').attr('class', 'all')
                .attr('width', forcrConfig.width)
                .attr('height', forcrConfig.height)

            this.force = d3.layout.force()
                .nodes(nodes)
                .links(links)
                .gravity(.001)
                .distance(forcrConfig.distance)
                .charge(function (d) {
                    return (-10 * d.index)
                })
                .size([forcrConfig.width, forcrConfig.height])
                .start();

            this.vis.append('svg:defs').selectAll('marker')
                .data(['end'])
                .enter().append('svg:marker')
                .attr('id', 'arrow')
                .attr('class', 'arrow')
                .attr('viewBox', '0 -5 10 10')
                .attr('refX', 27)
                .attr('refY', 0)
                .attr('markerWidth', 9)
                .attr('markerHeight', 16)
                .attr('markerUnits', 'userSpaceOnUse')
                .attr('orient', 'auto')
                .append('svg:path')
                .attr('d', 'M0,-5L10,0L0,5')
                .attr('fill', '#666');

            this.links = this.vis.selectAll('line.link')
                .data(links)
                .enter().append('svg:line')
                .attr('class', 'link')
                .attr('stroke-width', 1)
                .attr('x1', function (d) {
                    return d.source.x;
                })
                .attr('y1', function (d) { return d.source.y; })
                .attr('x2', function (d) { return d.target.x; })
                .attr('y2', function (d) { return d.target.y; })
                .attr('marker-end', 'url(#arrow)')
                .attr('stroke', '#999');

            const dragstart = function (d, i) {
                _this.force.stop();
                d3.event.sourceEvent.stopPropagation();
            };

            const dragmove = function (d, i) {
                d.px += d3.event.dx;
                d.py += d3.event.dy;
                d.x += d3.event.dx;
                d.y += d3.event.dy;
                _this.tick();
            };

            const dragend = function (d, i) {
                d.fixed = true;
                _this.tick();
                _this.force.resume();
            };

            this.nodeDrag = d3.behavior.drag()
                .on('dragstart', dragstart)
                .on('drag', dragmove)
                .on('dragend', dragend);

            this.highlight = function (node) {
                if (node) {
                    if (node !== highlightNode) {
                        // 当前结点索引
                        const currIndex = node.index;
                        // 相关联的节点索引集合
                        let correlations = [currIndex];
                        links.forEach(function (link) {
                            if (currIndex == link['source']['index']) {
                                correlations = correlations.concat([link.target.index])
                            } else if (currIndex == link['target']['index']) {
                                correlations = correlations.concat([link.source.index])
                            }
                        });
                        // 样式高亮
                        _this.nodes.classed('inactive', function (d) {
                            return correlations.indexOf(d.index) == -1;
                        });
                        _this.links.classed('inactive', function (d) {
                            return node !== d.source && node !== d.target;
                        });
                        _this.linetext.classed('inactive', function (d) {
                            return d.source.index != node.index && d.target.index != node.index;
                        });
                    }

                    // 显示 Tips
                    const html = `
                        <div class='title'>${node.name}的资料</div>
                        <table class='detail-info'>
                            <tr><td class='td-label'>姓名：</td><td>LeYi</td></tr>
                            <tr><td class='td-label'>技能：</td><td>D3</td></tr>
                            <tr><td class='td-label'>博客：</td><td><a href='http://www.cnblogs.com/leyi'>韭菜茄子</a></td></tr>
                        </table>
                    `;
                    _this.tooltip.html(html)
                        .style('left', (d3.event.pageX + 20) + 'px')
                        .style('top', (d3.event.pageY - 20) + 'px')
                        .style('opacity', 1.0);
                    highlightNode = node;
                } else {
                    if (highlightNode) {
                        _this.nodes.classed('inactive', false);
                        _this.links.classed('inactive', false);
                        _this.linetext.classed('inactive', false);
                    }
                    _this.tooltip.style('opacity', 0.0);
                    highlightNode = null;
                }
            };

            this.tooltip = d3.select('body').append('div')
                .attr('class', 'tooltip')
                .attr('opacity', 0.0)
                .on('mouseover', function () {
                    if (_this.nodes.mouseoutTimeout) {
                        clearTimeout(_this.nodes.mouseoutTimeout);
                        _this.nodes.mouseoutTimeout = null;
                    }
                })
                .on('mouseout', function () {
                    if (_this.nodes.mouseoutTimeout) {
                        clearTimeout(_this.nodes.mouseoutTimeout);
                        _this.nodes.mouseoutTimeout = null;
                    }
                    _this.nodes.mouseoutTimeout = setTimeout(function () {
                        _this.highlight(null);
                    }, 300);
                });

            this.nodes = this.vis.selectAll('g.node')
                .data(nodes)
                .enter().append('svg:g')
                .attr('class', 'node')
                .style('cursor', 'pointer')
                .call(_this.nodeDrag)
                .on('mouseover', function (d) {
                    if (_this.nodes.mouseoutTimeout) {
                        clearTimeout(_this.nodes.mouseoutTimeout);
                        _this.nodes.mouseoutTimeout = null;
                    }
                    _this.highlight(d);
                })
                .on('mouseout', function () {
                    if (_this.nodes.mouseoutTimeout) {
                        clearTimeout(_this.nodes.mouseoutTimeout);
                        _this.nodes.mouseoutTimeout = null;
                    }
                    _this.nodes.mouseoutTimeout = setTimeout(function () {
                        _this.highlight(null);
                    }, 300);
                });


            this.nodes.append('svg:image')
                .attr('class', 'circle')
                .attr('xlink:href', 'images/mobile.png')
                .attr('x', '-15px')
                .attr('y', '-15px')
                .attr('width', '30px')
                .attr('height', '30px');

            this.nodes.append('svg:text')
                .attr('class', 'nodetext')
                .attr('dy', '30px')
                .attr('text-anchor', 'middle')
                .text(function (d) { return d.name })
                .attr('fill', function (d, i) {
                    return _this.color(i);
                });

            this.linetext = this.vis.selectAll('.linetext')
                .data(links)
                .enter()
                .append('text')
                .attr('class', 'linetext')
                .attr('x', function (d) { return (d.source.x + d.target.x) / 2 })
                .attr('y', function (d) { return (d.source.y + d.target.y) / 2 })
                .text(function (d) {
                    return d.relation
                })
                .attr('fill', function (d, i) {
                    return _this.color(i);
                })
                .call(this.force.drag);

            this.zoomed = function () {
                _this.vis.attr('transform', 'translate(' + d3.event.translate + ') scale(' + d3.event.scale + ')')
            };

            this.tick = function () {
                _this.links
                    .attr('x1', function (d) { return d.source.x; })
                    .attr('y1', function (d) { return d.source.y; })
                    .attr('x2', function (d) { return d.target.x })
                    .attr('y2', function (d) { return d.target.y; });

                _this.linetext
                    .attr('x', function (d) { return (d.source.x + d.target.x) / 2 })
                    .attr('y', function (d) { return (d.source.y + d.target.y) / 2 });

                _this.nodes.attr('transform', function (d) { return 'translate(' + d.x + ',' + d.y + ')'; });

            };

            _this.force.on('tick', this.tick);
        }
    </script>
</body>

</html>